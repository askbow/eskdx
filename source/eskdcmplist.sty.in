% Copyright 2006 Konstantin Korikov <lostclus@ua.fm>
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2003/12/01 or later.
%
% This work has the LPPL maintenance status "maintained".
% 
% This Current Maintainer of this work is Konstantin Korikov.
%
% This work consists of all files listed in manifest.txt.
%
m4_ESKDX_INIT
m4_FILE_INIT
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{eskdcmplist}[m4_dnl
m4_FILE_ID([[$Date:: 2010-03-08 14:28:10 +0200 #$]]) Component List GOST 2.701-84]


\RequirePackage{eskdlang}
\RequirePackage{eskdstamp}
\RequirePackage{rotating}
\RequirePackage{array}
\RequirePackage{calc}
\RequirePackage{longtable}


% несколько служебных длин. Сразу же зададим умолчания
\newlength{\ESKDtabBodieH} % высота тела таблицы
\newlength{\ESKDtabHeadH} % высота заголовка таблицы
\newlength{\ESKDtabLineSpace} % расстояние между строками
\newlength{\ESKDtabFootH} % высота подвала таблицы 
\ESKDtabHeadH=15mm
\ESKDtabLineSpace=8mm

% дадим осмысленно название счетчику
\let\ESKDlineCount=\ESKD@tmpcnta



% функция разлиновки листа
\newcommand{\ESKDdrawComponentList}[1]{% принимает один необязательный
% параметр, чтобы рисовать другую таблицу для второго и последующих листов
  \put(\ESKDltu{\ESKDframeX},\ESKDltu{\ESKDframeY}){%
    \begin{picture}(0,0)
      \if 1#1 % настройки для второго и последующего листов 
        \ESKD@tmpdima=\ESKD@style@sh@formIIab % высота рамки минус высота штампа.
        % Для второго и последующих листов сделаем пустое пространство на 2 строки
        % это требование ГОСТа. Так сделано для возможности руками дорисовывать
        % штамп вверх, когда для фиксации изменений не будет хватать граф.
        \setlength{\ESKD@tmpdima}{\ESKD@tmpdima + 2\ESKDtabLineSpace}
      \else
        \ESKD@tmpdima=\ESKD@style@sh@formII
      \fi
      % чтобы получить высоту тела таблицы, вычтем из высоты рамки
      % высоту шапки и скорректированную (если надо) высоту штампа
      \setlength{\ESKDtabBodieH}{\ESKDframeH - \ESKD@tmpdima - \ESKDtabHeadH}
      % посчитаем, сколько строк укладывается на лист
      \setlength{\ESKD@tmpdima}{\ESKDtabBodieH / \ESKDtabLineSpace}
      \ESKDlineCount=\ESKD@tmpdima % в этот счетчик сохраним рассчитанное количество строк
      % скорректируем высоту таблицы с учетом того, что в нее укладывается не целое количество строк
      \setlength{\ESKDtabBodieH}{\ESKDtabLineSpace * \ESKDlineCount}
      % сохраним в "а" расстояние между нижним краем рамки и нижним краем таблицы
      \setlength{\ESKD@tmpdima}{\ESKDframeH - \ESKDtabHeadH - \ESKDtabBodieH}

      % рисуем вертикальные линии на высоте "а" от нижнего края рамки длинной в высоту таблицы
      \linethickness{\ESKDlineThick}
      \put(20,\ESKDltu{\ESKD@tmpdima}){\line(0,1){\ESKDltu{\ESKDtabBodieH}}}
      \put(130,\ESKDltu{\ESKD@tmpdima}){\line(0,1){\ESKDltu{\ESKDtabBodieH}}}
      \put(140,\ESKDltu{\ESKD@tmpdima}){\line(0,1){\ESKDltu{\ESKDtabBodieH}}}

      % рисуем рассчитанное количество горизонтальных линий начиная снизу ("а")
      \linethickness{\ESKDlineThin}
      \multiput(0,\ESKDltu{\ESKD@tmpdima})(0,\ESKDltu{\ESKDtabLineSpace}){\the\ESKDlineCount}{%
        \line(1,0){\ESKDltu{\ESKDframeW}}}



      % нарисуем и заполним шапку таблицы
      %
      % вычислим расстояние от нижнего края рамки до нижнего края шапки таблицы
      \setlength{\ESKD@tmpdima}{\ESKDframeH - \ESKDtabHeadH} 
      % отчеркнем нижний край шапки
      \linethickness{\ESKDlineThick}
      \put(0,\ESKDltu{\ESKD@tmpdima}){\line(1,0){\ESKDltu{\ESKDframeW}}}
      % нарисуем вертикальные линии шапки
      \put(20,\ESKDltu{\ESKD@tmpdima}){\line(0,1){\ESKDltu{\ESKDtabHeadH}}}
      \put(130,\ESKDltu{\ESKD@tmpdima}){\line(0,1){\ESKDltu{\ESKDtabHeadH}}}
      \put(140,\ESKDltu{\ESKD@tmpdima}){\line(0,1){\ESKDltu{\ESKDtabHeadH}}}


    \end{picture}}}




% на случай, если запись не влезет в одну строку и произойдет перенос на
% следующую, вручную зададим интерлиньяж равный \ESKDtabLineSpace Возможно
% есть смысл задать такой интерлиньяж в eskdfont, для всех табличных
% документов, а не переопределять здесь.
\renewcommand{\ESKDfontTabBody}{\fontsize{10pt}{\ESKDtabLineSpace}\selectfont\ESKDfontShape}

% создадим окружение "перечень элементов"
\newenvironment{ESKDcomponentList}{%
\ESKDputOnStyle{formII}{componentlist}{\ESKDdrawComponentList{}}
\ESKDputOnStyle{formIIab}{componentlist}{\ESKDdrawComponentList{1}}
\begin{ESKDzeroPadding}%
\setlength{\tabcolsep}{0.5mm}%
\setlength{\LTpre}{0mm}%
\setlength{\LTpost}{0mm}%
\setlength{\LTleft}{0mm}%
\setlength{\LTright}{\fill}%
\newcolumntype{s}{>{\ESKDfontTabBody}c}%
\newcolumntype{n}{% вставим с двух сторон подпорки по 8мм
  >{\ESKDfontTabBody\raggedright\parbox[c][8mm][c]{0mm}{\rule{0mm}{0mm}}}%
  p{107mm}%
  <{\parbox[c][8mm][c]{0mm}{\rule{0mm}{0mm}}}}%
\noindent % 
% с помощью @-выражения зададим небольшой отступ для содержимого графы "наименование"
\begin{longtable}{s@{\hspace{2mm}}n@{\hspace{2mm}}ss}%
% изменим некоторые константы longtable для того, чтобы
% таблица занимала всё свободное место
\setlength{\ESKD@tmpdima}{\ESKDframeH - \ESKD@style@sh@formIIab - 2\ESKDtabLineSpace}%
\global\@colht\ESKD@tmpdima%
\global\@colroom\ESKD@tmpdima%
% заполним шапку таблицы
\parbox[c][15mm][c]{19mm}{\centering\ESKDfontTabHead%
\ESKDcmplistColumnIname}&
\parbox[c][15mm][c]{108mm}{\centering\ESKDfontTabHead%
\ESKDcmplistColumnIIname}&
\parbox[c][15mm][c]{9mm}{\centering\ESKDfontTabHead%
\ESKDcmplistColumnIIIname}&
\parbox[c][15mm][c]{44mm}{\centering\ESKDfontTabHead%
\ESKDcmplistColumnIVname}\\
% первые и последние строки листов сделаем пустыми
% для эстетичности 
&&&\\%
\endhead
&&&\\%
\endfoot}{%
\end{longtable}%
\end{ESKDzeroPadding}%
\ESKDremoveFromStyle{formII}{componentlist}%
\ESKDremoveFromStyle{formIIab}{componentlist}}



\let\ESKD@tmpcnta=\ESKDlineCount
